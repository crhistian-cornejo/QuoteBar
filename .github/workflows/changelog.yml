name: Auto Changelog

on:
  push:
    branches: [main]
    paths:
      - 'CHANGELOG.md'
      - '.github/workflows/changelog.yml'
  workflow_dispatch:
    inputs:
      from_version:
        description: 'Version to generate changelog from (e.g., v0.1.0)'
        required: false
        type: string
      to_version:
        description: 'Version to generate changelog to (e.g., v0.2.0)'
        required: false
        type: string

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Get current version
      id: current_version
      run: |
        # Get the latest tag
        git fetch --tags
        LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      uses: mikepenz/release-changelog-builder-action@v4
      with:
        fromTag: ${{ github.event.inputs.from_version || steps.current_version.outputs.latest_tag || 'v0.0.0' }}
        toTag: ${{ github.event.inputs.to_version || github.sha }}
        user: ${{ github.repository_owner }}
        repo: ${{ github.repository }}
        enableTruncate: true
        collapseWalkthrough: false
        prepend: |
          # Changelog
          
          ## Installation
          
          **Recommended:** Download ``QuoteBar-Setup-<version>.exe`` and run the installer.
          
          **Portable:** Download ``QuoteBar-Portable-<version>.zip``, extract anywhere, and run ``QuoteBar.exe``.
          
          ---
        append: |
          ---
          
          **Full Changelog:** https://github.com/crhistian-cornejo/QuoteBar/blob/main/CHANGELOG.md
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update CHANGELOG.md
      run: |
        # Read existing changelog
        cat CHANGELOG.md > CHANGELOG_backup.md
        
        # Create new changelog with header
        cat > CHANGELOG.md << 'EOF'
        # Changelog

        All notable changes to this project will be documented in this file.

        The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
        and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

        ## [Unreleased]
        
        *No unreleased changes.*

        EOF
        
        # Append the new changelog content
        echo "${{ steps.changelog.outputs.changelog }}" >> CHANGELOG.md
        
        # Append a separator and the old changelog (excluding the old unreleased section if it exists)
        echo "" >> CHANGELOG.md
        echo "---" >> CHANGELOG.md
        echo "" >> CHANGELOG.md
        tail -n +6 CHANGELOG_backup.md >> CHANGELOG.md

    - name: Create Pull Request for changelog update
      uses: peter-evans/create-pull-request@v7
      with:
        title: 'docs: Update CHANGELOG.md'
        body: |
          ## Summary
          This PR updates the changelog based on recent changes.
          
          > Generated by GitHub Action
        commit-message: 'docs: update CHANGELOG.md'
        branch: 'changelog-update'
        delete-branch: true
        labels: documentation, automated pr
